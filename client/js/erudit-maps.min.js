function update(t){var e=new google.maps.OverlayView;e.onAdd=function(){this.layer=d3.select(this.getPanes().overlayMouseTarget).append("div").attr("class","stations");var o={};e.draw=function(){function e(t){return o[t.documentid]=[t.lat,t.lng],t=new google.maps.LatLng(t.lat,t.lng),t=a.fromLatLngToDivPixel(t),d3.select(this).style("left",t.x-s+"px").style("top",t.y-s+"px").style("z-index",99)}function n(t){var e,n,s,i,l;$(this).empty(),dsrc=new google.maps.LatLng(o[t.source][0],o[t.source][1]),dtrg=new google.maps.LatLng(o[t.target][0],o[t.target][1]),d1=a.fromLatLngToDivPixel(dsrc),d2=a.fromLatLngToDivPixel(dtrg),d1.y<d2.y?(e=d1.y,n=d2.y):(e=d2.y,n=d1.y),d1.x<d2.x?(s=d1.x,i=d2.x):(s=d2.x,i=d1.x),l=d3.select(this).style("left",s+r+"px").style("top",e+r+"px").style("width",i-s-r+"px").style("height",n-e-r+"px").style("z-index",98).attr("doc-source",t.source).attr("doc-target",t.target);var d,c,p,u;return d1.y<d2.y&&d1.x<d2.x||d1.x>d2.x&&d1.y>d2.y?(d=0,c=i-s,p=0,u=n-e):(d1.y<d2.y&&d1.x>d2.x||d1.x<d2.x&&d1.y>d2.y)&&(d=i-s,c=0,p=0,u=n-e),l.append("svg:line").style("stroke-width",1).style("stroke","black").attr("x1",d).attr("y1",p).attr("x2",c).attr("y2",u),l}var r=1,a=this.getProjection(),s=10;this.layer.selectAll("svg").data(t.documents).each(e).enter().append("svg").each(e).attr("class","marker").attr("doc-id",function(t){return t.documentid}).attr("journal-id",function(t){return t.journalid}).on("mouseover",function(t){d3.select(this).selectAll("circle").attr({fill:"orange",r:9})}).on("mouseout",function(t){d3.select(this).selectAll("circle").attr({fill:"brown",r:4.5})}).on("click",function(t){pushInfoWidget(t)}).append("circle").attr("r",4.5).attr("cx",s).attr("cy",s);this.layer.selectAll(".links").data(t.links).each(n).enter().append("svg:svg").attr("class","links").each(n)},e.onRemove=function(){this.layer.remove()}},overlays.push(e),e.setMap(map)}function pushInfoWidget(t){if($("#winfo-"+t.documentid).length>0)return!1;var e="<div class='tool-box-widget' id='winfo-"+t.documentid+"'>    <span class='widget-close' onclick='$(this).parent().remove();'>x</span><h2>"+t.title+"</h2><p>Journal: "+t.journal+"<br/>Author: "+t.author+"<br/>Year: "+t.year+"<br/>Period: "+t.period+"</p></div>";return $("#tool-box").append(e),openSideBar(),!0}function openSideBar(){+$("#tool-box").css("right").replace("px","")<0&&toggleSideBar()}function closeSideBar(){0==+$("#tool-box").css("right").replace("px","")&&toggleSideBar()}function toggleSideBar(){+$("#tool-box").css("right").replace("px","")<0?$("#tool-box").css("right",0):$("#tool-box").css("right",-$("#tool-box").width()-15)}function showLinks(t){$("svg.links[doc-source='"+t+"']").show()}function hideLinks(t){void 0===t?$("svg.links").hide():$("svg.links[doc-source='"+t+"']").hide()}function showJournalLinks(t){hideLinks(),$("svg.marker[journal-id='"+t+"']").each(function(){$("svg.links[doc-source='"+$(this).attr("doc-id")+"']").each(function(){showNode($(this).attr("doc-target"))})})}function filterJournals(){for(;overlays.length>0;)overlays.pop().setMap(null);var t=$("select#journal-list").val(),e={documents:$.grep(map_data.documents,function(e,o){return $.inArray(e.journalid+"",t)>-1}),links:[]};console.log(e),update(e)}var map=new google.maps.Map(d3.select("#map").node(),{zoom:5,center:new google.maps.LatLng(55,-72),mapTypeId:google.maps.MapTypeId.TERRAIN,mapTypeControl:!1,scaleControl:!1,streetViewControl:!1,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER}}),map_data,overlays=[];$(document).ready(function(){$("#tool-box").width(.2*$(window).width()),d3.json("/entities",function(t,e){if(t)throw t;map_data=e,filterJournals()})});