function update(o){var e=new google.maps.OverlayView;e.onAdd=function(){this.layer=d3.select(this.getPanes().overlayMouseTarget).append("div").attr("class","stations");d3.select(this.getPanes().overlayLayer).append("div").attr("class","SvgOverlay").append("svg").append("g").attr("class","AdminDivisions");e.draw=function(){function e(o){return node_coord[o.entityid]=[o.lat,o.lng],o=new google.maps.LatLng(o.lat,o.lng),o=t.fromLatLngToDivPixel(o),d3.select(this).style("left",o.x-n+"px").style("top",o.y-n+"px").style("z-index",99)}var t=this.getProjection(),n=10;for(this.layer.selectAll("svg").data(d3.values(o.entities)).each(e).enter().append("svg").each(e).attr("class","marker").attr("doc-id",function(o){return o.entityid}).attr("journal-id",function(o){return o.entityid}).on("mouseover",function(o){d3.select(this).selectAll("circle").attr("r",9).style("stroke",rgb_highlight)}).on("mouseout",function(o){d3.select(this).selectAll("circle").attr("r",4.5).style("stroke",rgb_highlight)}).on("click",function(o){pushInfoWidget(o)&&console.log(o)}).append("circle").attr("r",4.5).attr("cx",n).attr("cy",n).attr("fill",function(o){return color_scale(o.entityid)});polygons.length>0;)polygons.pop().setMap(null);for(;polylines.length>0;)polylines.pop().setMap(null);for(r=0;r<o.documents.length;r++)if(0!=o.documents[r].links.length){var s=getGoogleCoords(o.documents[r].links);if(o.documents[r].links.length<3){var a=new google.maps.Polygon({path:s,geodesic:!0,strokeColor:"#008899",strokeOpacity:.5,strokeWeight:1});polylines.push(a)}else{var l=new google.maps.Polygon({paths:s,strokeColor:"#008899",strokeOpacity:.5,strokeWeight:1,fillColor:"#008899",fillOpacity:.3});polygons.push(l)}}for(r=0;r<polylines.length;r++)polylines[r].setMap(map);for(var r=0;r<polygons.length;r++)polygons[r].setMap(map)},e.onRemove=function(){this.layer.remove()}},overlays.push(e),e.setMap(map)}function getGoogleCoords(o){var e=[];o.length>1&&o.push(o[0]);for(var t=0;t<o.length;t++){if(t>0){var n=node_coord[o[t-1]][0],s=node_coord[o[t-1]][1],a=node_coord[o[t]][0],l=node_coord[o[t]][1],r=Math.abs(s-l);if(r>=180){var i=Math.abs(n-a)/5,d=r/5,c=1,p=1;for(s>l&&(p=-1),n>a&&(c=-1);s>l&&p<0||s<l&&p>0;)n+=i*c,s+=d*p,e.push(new google.maps.LatLng(n,s))}}e.push(new google.maps.LatLng(node_coord[o[t]][0],node_coord[o[t]][1]))}return e}function transformToGeoCollection(o){for(var e={type:"FeatureCollection",features:[]},t=0;t<o.length;t++)o[t].links.length>0&&e.features.push(transformToGeoFeature(o[t]));return e}function transformToGeoFeature(o){for(var e=[],t=0;t<o.links.length;t++)e.push([node_coord[o.links[t]][1],node_coord[o.links[t]][0]]);return e.push(e[0]),{type:"Feature",properties:{name:o.affiliation},geometry:{type:"Polygon",coordinates:[e]},id:"AFG"}}function pushInfoWidget(o){if($("#winfo-"+o.entityid).length>0)return!1;var e="<div class='tool-box-widget' id='winfo-"+o.entityid+"'>    <span class='widget-close' onclick='$(this).parent().remove();'>x</span><h2>"+o.affiliation+"</h2><p>Address: "+o.addr+"<br/>Lat: "+o.lat+"<br/>Lng: "+o.lng+"<br/></div>";return $("#tool-box").append(e),getDocumentsByEntity(o.entityid),openSideBar(),!0}function getDocumentsByEntity(o){var e=$.grep(filter_data.documents,function(e,t){return e.entityid==o});console.log(e)}function openSideBar(){+$("#tool-box").css("right").replace("px","")<0&&toggleSideBar()}function closeSideBar(){0==+$("#tool-box").css("right").replace("px","")&&toggleSideBar()}function toggleSideBar(){+$("#tool-box").css("right").replace("px","")<0?$("#tool-box").css("right",0):$("#tool-box").css("right",-$("#tool-box").width()-15)}function showLinks(o){$("svg.links[doc-source='"+o+"']").show()}function hideLinks(o){void 0===o?$("svg.links").hide():$("svg.links[doc-source='"+o+"']").hide()}var $map=$("#map"),map=new google.maps.Map(d3.select("#map").node(),{zoom:5,center:new google.maps.LatLng(55,-72),mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!1,scaleControl:!1,streetViewControl:!1,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},styles:[{stylers:[{saturation:-50},{lightness:50}]}]}),map_data,filter_data,overlays=[],colors=["#e07b91","#d33f6a","#11c638","#8dd593","#c6dec7","#ead3c6","#f0b98d","#ef9708","#0fcfc0","#9cded6","#d5eae7","#f3e1eb","#f6c4e1","#f79cd4","#023fa5","#7d87b9","#bec1d4","#d6bcc0","#bb7784","#8e063b","#4a6fe3","#8595e1","#b5bbe3","#e6afb9"],color_scale=d3.scale.ordinal().range(colors),node_coord={},polygons=[],polylines=[];$(document).ready(function(){$("#tool-box").width(.2*$(window).width()),d3.json("/entities",function(o,e){if(o)throw o;filter_data=map_data=e,extractJournalList(map_data.documents),update(map_data)})});