function update(e){var t=new google.maps.OverlayView;t.onAdd=function(){this.layer=d3.select(this.getPanes().overlayMouseTarget).append("div").attr("class","stations");var o={};t.draw=function(){function t(e){return o[e.documentid]=[e.lat,e.lng],e=new google.maps.LatLng(e.lat,e.lng),e=r.fromLatLngToDivPixel(e),d3.select(this).style("left",e.x-n+"px").style("top",e.y-n+"px").style("z-index",99)}function l(e){var t,l,n,d,i;$(this).empty(),dsrc=new google.maps.LatLng(o[e.source][0],o[e.source][1]),dtrg=new google.maps.LatLng(o[e.target][0],o[e.target][1]),d1=r.fromLatLngToDivPixel(dsrc),d2=r.fromLatLngToDivPixel(dtrg),d1.y<d2.y?(t=d1.y,l=d2.y):(t=d2.y,l=d1.y),d1.x<d2.x?(n=d1.x,d=d2.x):(n=d2.x,d=d1.x),i=d3.select(this).style("left",n+s+"px").style("top",t+s+"px").style("width",d-n-s+"px").style("height",l-t-s+"px").style("z-index",98).attr("doc-source",e.source).attr("doc-target",e.target);var a,c,g,p;return d1.y<d2.y&&d1.x<d2.x||d1.x>d2.x&&d1.y>d2.y?(a=0,c=d-n,g=0,p=l-t):(d1.y<d2.y&&d1.x>d2.x||d1.x<d2.x&&d1.y>d2.y)&&(a=d-n,c=0,g=0,p=l-t),i.append("svg:line").style("stroke-width",1).style("stroke",rgb_stroke).attr("x1",a).attr("y1",g).attr("x2",c).attr("y2",p),i}var s=1,r=this.getProjection(),n=10;this.layer.selectAll("svg").data(e.documents).each(t).enter().append("svg").each(t).attr("class","marker").attr("doc-id",function(e){return e.documentid}).attr("journal-id",function(e){return e.journalid}).on("mouseover",function(e){d3.select(this).selectAll("circle").attr("r",9).style("stroke",rgb_highlight),d3.selectAll("svg.links[doc-target='"+e.documentid+"']").selectAll("line").style("stroke",rgb_highlight),d3.selectAll("svg.links[doc-source='"+e.documentid+"']").selectAll("line").style("stroke",rgb_highlight)}).on("mouseout",function(e){d3.select(this).selectAll("circle").attr("r",4.5).style("stroke",rgb_highlight),d3.selectAll("svg.links[doc-target='"+e.documentid+"']").selectAll("line").style("stroke",rgb_stroke),d3.selectAll("svg.links[doc-source='"+e.documentid+"']").selectAll("line").style("stroke",rgb_stroke)}).on("click",function(e){pushInfoWidget(e)}).append("circle").attr("r",4.5).attr("cx",n).attr("cy",n).attr("fill",function(e){return color_scale(e.journalid)});this.layer.selectAll(".links").data(e.links).each(l).enter().append("svg:svg").attr("class","links").each(l)},t.onRemove=function(){this.layer.remove()}},overlays.push(t),t.setMap(map)}function pushInfoWidget(e){if($("#winfo-"+e.documentid).length>0)return!1;var t="<div class='tool-box-widget' id='winfo-"+e.documentid+"'>    <span class='widget-close' onclick='$(this).parent().remove();'>x</span><h2>"+e.title+"</h2><p>Journal: "+e.journal+"<br/>Author: "+e.author+"<br/>Year: "+e.year+"<br/>Period: "+e.period+"</p></div>";return $("#tool-box").append(t),openSideBar(),!0}function openSideBar(){+$("#tool-box").css("right").replace("px","")<0&&toggleSideBar()}function closeSideBar(){0==+$("#tool-box").css("right").replace("px","")&&toggleSideBar()}function toggleSideBar(){+$("#tool-box").css("right").replace("px","")<0?$("#tool-box").css("right",0):$("#tool-box").css("right",-$("#tool-box").width()-15)}function showLinks(e){$("svg.links[doc-source='"+e+"']").show()}function hideLinks(e){void 0===e?$("svg.links").hide():$("svg.links[doc-source='"+e+"']").hide()}var map=new google.maps.Map(d3.select("#map").node(),{zoom:5,center:new google.maps.LatLng(55,-72),mapTypeId:google.maps.MapTypeId.TERRAIN,mapTypeControl:!1,scaleControl:!1,streetViewControl:!1,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER}}),map_data,overlays=[],colors=["#e07b91","#d33f6a","#11c638","#8dd593","#c6dec7","#ead3c6","#f0b98d","#ef9708","#0fcfc0","#9cded6","#d5eae7","#f3e1eb","#f6c4e1","#f79cd4","#023fa5","#7d87b9","#bec1d4","#d6bcc0","#bb7784","#8e063b","#4a6fe3","#8595e1","#b5bbe3","#e6afb9"],color_scale=d3.scale.ordinal().range(colors);$(document).ready(function(){$("#tool-box").width(.2*$(window).width()),d3.json("/entities",function(e,t){if(e)throw e;map_data=t,filterJournals()})});