function drawJournalList(){$("#journal-list option").remove();var t="";for(var e in journal_data)if(!($.inArray(e+"",selected_journals)>-1)){var r=journal_data[e],l=r.count?r.count:0;t+="<option value='"+e+"'>"+r.title+" ("+l+")</option>"}$("#journal-list").append(t)}function drawSelectedJournals(){for(var t=0;t<selected_journals.length;t++)if(!($("#journal-filter li[journal-id='"+selected_journals[t]+"']").length>0)){var e=selected_journals[t],r=journal[selected_journals[t]],l="<li class='filter-item' journal-id='"+e+"'><span class='filter-legend'       style='background-color:"+color_scale(e)+";'></span>"+r.title+" ("+r.count+")      <span class='filter-close'       onclick='removeJournalFilter(this)'>x</span></li>";$("ul#journal-filter").append(l)}highlightJournal()}function highlightJournal(){$(".filter-item").on("mouseover",function(){hl_journal_id=$(this).attr("journal-id"),update(filter_data)}),$(".filter-item").on("mouseout",function(){hl_journal_id=null,update(filter_data)})}function removeJournalFilter(t){var e=$(t).parent(),r=e.attr("journal-id");e.remove(),selected_journals=selected_journals.filter(function(t){return t!=r}),applyFilters(!0)}function filterJournals(t,e){if(0==(selected_journals=selected_journals.concat($("select#journal-list").val())).length)return $("#journal-filter i").show(),$("#filter-list h2.journal").html("Selected Journals"),t;$("#journal-filter i").hide(),$("#filter-list h2.journal").html("Selected Journals ("+selected_journals.length+")");var r=[],l=$.grep(t.documents,function(t,e){return $.inArray(t.journalid+"",selected_journals)>-1&&(-1==$.inArray(t.entityid+"",r)&&r.push(t.entityid),!0)}),a={};for(var n in r)a[r[n]]=t.entities[r[n]];for(var o={documents:l,entities:a},i=0;i<selected_journals.length;i++)$("#journal-list option[value='"+selected_journals[i]+"']").remove();if(e)return o;update(o)}function applyFilters(t){clearOverlay(),filter_data=filterJournals(map_data,!0),drawJournalList(),filter_data=filterAuthors(filter_data,!0);var e=filter_data.documents?filter_data.documents:[];author_data=extractAuthorList(e),drawAuthorList(),t&&(drawSelectedJournals(),drawSelectedAuthors()),update(filter_data)}function clearOverlay(){for(;overlays.length>0;)overlays.pop().setMap(null)}function extractJournalList(t){var e=[];journal_data={};for(var r=0;r<t.length;r++){var l=t[r].journalid;e.includes(l)||(e.push(l),journal_data[l]=journal[l])}drawJournalList()}function removeAuthorFilter(t){var e=$(t).parent(),r=e.attr("author-id");e.remove(),selected_authors=selected_authors.filter(function(t){return t!=r}),applyFilters(!0)}function filterAuthors(t,e){if(0==(selected_authors=selected_authors.concat($("select#author-list").val())).length)return $("#author-filter i").show(),$("#filter-list h2.author").html("Selected Authors"),t;$("#author-filter i").hide(),$("#filter-list h2.author").html("Selected Authors ("+selected_authors.length+")");var r=[],l=$.grep(t.documents,function(t,e){return $.inArray(t.authorid+"",selected_authors)>-1&&(-1==$.inArray(t.entityid+"",r)&&r.push(t.entityid),!0)}),a={};for(var n in r)a[r[n]]=t.entities[r[n]];for(var o={documents:l,entities:a},i=0;i<selected_authors.length;i++)$("#author-list option[value='"+selected_authors[i]+"']").remove();if(e)return o;update(o)}function drawSelectedJournals(){for(var t=0;t<selected_journals.length;t++)if(!($("#journal-filter li[journal-id='"+selected_journals[t]+"']").length>0)){var e=selected_journals[t],r=journal[selected_journals[t]],l="<li class='filter-item' journal-id='"+e+"'><span class='filter-legend'       style='background-color:"+color_scale(e)+";'></span>"+r.title+" ("+r.count+")      <span class='filter-close'       onclick='removeJournalFilter(this)'>x</span></li>";$("ul#journal-filter").append(l)}highlightJournal()}function drawSelectedAuthors(){for(var t=0;t<selected_authors.length;t++)if(!($("#author-filter li[author-id='"+selected_authors[t]+"']").length>0)){var e=selected_authors[t],r=author_data[selected_authors[t]],l="<li class='filter-item' author-id='"+e+"'><span class='filter-legend'       style='background-color:"+color_scale(e)+";'></span>"+r.name+" ("+r.count+")      <span class='filter-close'       onclick='removeAuthorFilter(this)'>x</span></li>";$("ul#author-filter").append(l)}}function extractAuthorList(t){for(var e=[],r={},l=0;l<t.length;l++){var a=t[l].authorid;e.includes(a)?r[a].count+=1:(e.push(a),r[a]={},r[a].name=t[l].author,r[a].count=1)}return r}function drawAuthorList(){$("#author-list option").remove();var t="";for(var e in author_data)if(!($.inArray(e+"",selected_authors)>-1)){var r=author_data[e],l=r.count?r.count:0;t+="<option value='"+e+"'>"+r.name+" ("+l+")</option>"}$("#author-list").append(t)}function extractJournalEntity(t){for(var e=0;e<t.length;e++){var r=t[e].journalid,l=t[e].entityid;journal_entity_map[r]?$.inArray(l,journal_entity_map[r])<0&&journal_entity_map[r].push(l):journal_entity_map[r]=[l]}}var journal={},journal_data={},author_data={},journal_entity_map={},selected_journals=[],selected_authors=[],hl_journal_id=null,selected_entity=[];d3.json("/journal",function(t,e){journal=e});